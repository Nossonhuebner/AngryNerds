<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title>Gamedev Canvas Workshop</title>
    <style>
      * {
        /* padding: 50px; */
        margin: 50px;
      }
      canvas {
        background: #eee;
        display: block;
        margin: 0 auto;
      }
    </style>
  </head>
  <body>
    <script type="text/javascript" src="canvas.js"></script>
    <canvas id="myCanvas" width="850" height="420" style="background: url('./angry_background.png'); background-repeat: no-repeat;
    background-size: 100%;
    background-position-y: -217px;"></canvas>

    <script>
      var canvas = document.getElementById("myCanvas");
      var ctx = canvas.getContext("2d");
      var ballRadius = 10;
      const slingY = 263;
      const slingX = 98;
      var x = slingX;
      var y = slingY;
      var dx = 2;
      var dy = -2;
      var paddleHeight = 10;
      var rightPressed = false;
      var leftPressed = false;
      var score = 0;
      var lives = 3;
      var gravity = 0.5;
      var friction = 0.995;
      const ballWeight = 1;
      const boxWeight = 2;
      let boxX = 400;
      let boxY = 200;
      let by;
      let bx;
      let hit = false;
      let mouseHold = false;
      let pos;
      let mpos;
      let released = false;
      let action = false;

      function mousePos(canvas, event) {
        a = canvas.getBoundingClientRect()
        pos = {
          x: event.clientX - a.left,
          y: event.clientY - a.top
        }
        console.log(pos);
        return pos;
      }

      canvas.addEventListener('mousedown', (e) => {
        mouseHold = true;
        action = true;
      });

      canvas.addEventListener('mouseup', (e) => {
        mouseHold = false;
        released = true;
        pos = null;
      });

      canvas.addEventListener('mousemove', (e) => {
        mpos = mousePos(canvas, e);
      });

      function drawBall() {
        ctx.beginPath();
        ctx.arc(x, y, ballRadius, 0, Math.PI * 2);
        ctx.fillStyle = "#f10d0d";
        ctx.fill();
        ctx.closePath();

        if (x + dx > canvas.width - ballRadius || x + dx < ballRadius) {
          console.log('hit side')
          dx = -dx;
        }
      }
      function drawBox() {
        const size = 50;
        if (x > boxX && x < boxX + size && y > boxY && y < boxY + size) {
          hit = true;
          bx = dx;
          by = dy;
          dx = -dx;
          dy = -dy;
        }

        if (boxX + bx > canvas.width - size || boxX + bx < size) {
          console.log('hit side')
          bx = -bx;
        } else if (by + boxY > canvas.height - size - 38 || by + boxY < size) {
          by = -by
        }

        if (hit) {
          if (boxY + by + (boxWeight * gravity) + size + size < canvas.height + size - 38) {
            by += (boxWeight * gravity);
          }
          bx *= friction;
          boxX += bx;
          boxY += by;
        }

        ctx.beginPath();
        ctx.rect(boxX, boxY, size, size)
        ctx.fillStyle = "#f10d0d";
        ctx.fill();
        ctx.closePath();
      }

      function drawSling() {
        ctx.strokeStyle = 'black';
        ctx.beginPath();
        ctx.moveTo(76, 250);
        ctx.lineTo(120, 276);
        ctx.lineWidth = 1;
        ctx.stroke();
      }

      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawBall();
        drawSling();
        drawBox();
        if (y + dy < ballRadius || y + dy > canvas.height - ballRadius - 38) {
          console.log('hit y')
          dy = -dy;
        }
        if (y + dy + gravity + ballRadius < canvas.height - 38 && !(mouseHold)) {
          dy += gravity
        }
        if (mouseHold) {
          x = mpos.x
          y = mpos.y
        } else if (released) {
          released = false;
          const pullY = slingY - mpos.y;
          const pullX = slingX - mpos.x;
          console.log(pullY);
          console.log(pullX);
          dy = pullY / 5;
          dx = pullX / 5;
          dy += gravity;
        }
        if (action) {
          dx *= friction;
          x += dx;
          y += dy;
        }

        requestAnimationFrame(draw);
      }

      draw();
    </script>

  </body>
</html>